<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BattleAura - Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="header">
        <h1>‚öôÔ∏è Modular Device Configuration</h1>
        <p><a href="/" class="link-orange">‚Üê Back to Control Panel</a></p>
        <p class="text-secondary" style="font-size: 14px;">Configure pins by type and group for modular effect control</p>
    </div>

    <form id="configForm" method="POST">
        <!-- System Settings -->
        <div class="status">
            <h3>üîß System Settings</h3>
            <div class="form-row">
                <label>Device Name:</label>
                <input type="text" name="deviceName" id="deviceName" maxlength="32" placeholder="Tank, Beast, Dreadnought...">
            </div>
            <div class="form-row">
                <label>Audio Volume:</label>
                <input type="range" name="volume" id="volume" min="0" max="30" oninput="document.getElementById('volDisplay').innerText = this.value">
                <span class="brightness-display" id="volDisplay">15</span>
            </div>
            <div class="form-row">
                <label>Audio Enabled:</label>
                <input type="checkbox" name="audioEnabled" id="audioEnabled">
            </div>
        </div>

        <!-- WiFi Settings -->
        <div class="status">
            <h3>üì° WiFi Settings</h3>
            <div class="form-row">
                <label>WiFi SSID:</label>
                <input type="text" name="wifiSSID" id="wifiSSID" maxlength="32">
            </div>
            <div class="form-row">
                <label>WiFi Password:</label>
                <input type="password" name="wifiPassword" id="wifiPassword" maxlength="64">
            </div>
            <div class="form-row">
                <label>WiFi Enabled:</label>
                <input type="checkbox" name="wifiEnabled" id="wifiEnabled">
            </div>
        </div>

        <!-- Pin Configuration -->
        <div class="status">
            <h3>üéØ Modular Pin Configuration</h3>
            <p class="text-secondary" style="font-size: 13px; margin-bottom: 20px;">
                Configure each pin with type and group for automatic effect targeting.
                Same firmware works across different miniatures through configuration.
            </p>
            <div id="pinConfigs">
                <!-- Pin configs will be loaded here by JavaScript -->
            </div>
        </div>

        <input type="submit" value="üíæ Save Config">
    </form>
    
    <div class="text-center">
        <button onclick="restartDevice()" class="btn btn-orange">
            üîÑ Restart Device
        </button>
        <p class="text-secondary" style="font-size: 12px; margin: 5px 0 0 0;">Required to apply WiFi changes</p>
    </div>

    <div class="status">
        <h4>üí° Configuration Tips:</h4>
        <ul style="margin: 10px 0;">
            <li><strong>Types</strong> define what the pin controls (Engine, Weapon, etc.)</li>
            <li><strong>Groups</strong> allow multiple pins of same type (Engine1, Engine2)</li>
            <li><strong>Effects</strong> will target types, not individual pins</li>
            <li><strong>Same firmware</strong> works for Tank, Beast, Dreadnought through config</li>
        </ul>
    </div>

    <script src="/app.js"></script>
    <script>
        // Configuration page specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
        });

        function loadConfiguration() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    // Populate system settings
                    document.getElementById('deviceName').value = config.deviceName || '';
                    document.getElementById('volume').value = config.volume || 15;
                    document.getElementById('volDisplay').textContent = config.volume || 15;
                    document.getElementById('audioEnabled').checked = config.audioEnabled || false;
                    document.getElementById('wifiSSID').value = config.wifiSSID || '';
                    document.getElementById('wifiPassword').value = config.wifiPassword || '';
                    document.getElementById('wifiEnabled').checked = config.wifiEnabled || false;

                    // Generate pin configuration forms
                    generatePinConfigs(config.pins || []);
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        function generatePinConfigs(pins) {
            const container = document.getElementById('pinConfigs');
            container.innerHTML = '';

            pins.forEach((pin, index) => {
                const pinDiv = document.createElement('div');
                pinDiv.className = 'pin-config';
                
                let typeDisplay = '';
                if (pin.enabled && pin.type) {
                    typeDisplay = ` - <span class="text-accent">${pin.type}${pin.group ? ` (${pin.group})` : ''}</span>`;
                }

                pinDiv.innerHTML = `
                    <div class="pin-header">
                        <h4>üîå Pin Slot ${index + 1}${typeDisplay}</h4>
                    </div>
                    <div class="form-row">
                        <label>GPIO Pin:</label>
                        <input type="number" name="gpio${index}" value="${pin.gpio || 0}" min="0" max="21">
                    </div>
                    <div class="form-row">
                        <label>Pin Mode:</label>
                        <select name="mode${index}" onchange="toggleLedCountField(${index}, this.value)">
                            <option value="0" ${pin.mode === 0 ? 'selected' : ''}>Disabled</option>
                            <option value="1" ${pin.mode === 1 ? 'selected' : ''}>Digital Output</option>
                            <option value="2" ${pin.mode === 2 ? 'selected' : ''}>PWM Output</option>
                            <option value="3" ${pin.mode === 3 ? 'selected' : ''}>WS2812B RGB</option>
                            <option value="4" ${pin.mode === 4 ? 'selected' : ''}>Digital Input</option>
                            <option value="5" ${pin.mode === 5 ? 'selected' : ''}>Analog Input</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Pin Name:</label>
                        <input type="text" name="name${index}" value="${pin.name || ''}" maxlength="16" placeholder="Descriptive name...">
                    </div>
                    <div class="form-row">
                        <label>Enabled:</label>
                        <input type="checkbox" name="enabled${index}" ${pin.enabled ? 'checked' : ''}>
                    </div>
                    <div class="form-row">
                        <label>Pin Type:</label>
                        <select name="type${index}" onchange="updateTypeDescription(${index}, this.value)">
                            <option value="">Select Type...</option>
                            <option value="Engine" ${pin.type === 'Engine' ? 'selected' : ''}>Engine (idle, rev effects)</option>
                            <option value="MachineGun" ${pin.type === 'MachineGun' ? 'selected' : ''}>Machine Gun (burst fire effect)</option>
                            <option value="Flamethrower" ${pin.type === 'Flamethrower' ? 'selected' : ''}>Flamethrower (flame whoosh effect)</option>
                            <option value="RocketLauncher" ${pin.type === 'RocketLauncher' ? 'selected' : ''}>Rocket Launcher (rocket launch effect)</option>
                            <option value="MainCannon" ${pin.type === 'MainCannon' ? 'selected' : ''}>Main Cannon (cannon blast effect)</option>
                            <option value="Candle" ${pin.type === 'Candle' ? 'selected' : ''}>Candle (flicker, bright effects)</option>
                            <option value="Console" ${pin.type === 'Console' ? 'selected' : ''}>Console (data scroll, alert pulse)</option>
                            <option value="Damage" ${pin.type === 'Damage' ? 'selected' : ''}>Damage (hit sparks, system failure)</option>
                            <option value="Ambient" ${pin.type === 'Ambient' ? 'selected' : ''}>Ambient (general lighting effects)</option>
                            <option value="Custom" ${pin.type && !['Engine','MachineGun','Flamethrower','RocketLauncher','MainCannon','Candle','Console','Damage','Ambient'].includes(pin.type) ? 'selected' : ''}>Custom Type</option>
                        </select>
                        <input type="text" name="customType${index}" id="customType${index}" value="${!['Engine','MachineGun','Flamethrower','RocketLauncher','MainCannon','Candle','Console','Damage','Ambient',''].includes(pin.type || '') ? pin.type : ''}" maxlength="20" placeholder="Enter custom type..." style="display: ${!['Engine','MachineGun','Flamethrower','RocketLauncher','MainCannon','Candle','Console','Damage','Ambient',''].includes(pin.type || '') ? 'inline-block' : 'none'}; margin-left: 10px; width: 150px;">
                    </div>
                    <div class="type-examples" id="typeDescription${index}">Effect buttons that will appear on main page based on configured pin types</div>
                    <div class="form-row">
                        <label>Pin Group:</label>
                        <input type="text" name="group${index}" value="${pin.group || ''}" maxlength="20" placeholder="Engine1, Weapon1, Candles...">
                    </div>
                    <div class="type-examples">Examples: Engine1, Engine2, Weapon1, Weapon2, MainCandles, SpotLights</div>
                    <div class="form-row">
                        <label>Brightness:</label>
                        <input type="range" name="brightness${index}" value="${pin.brightness || 255}" min="0" max="255" oninput="document.getElementById('brightness${index}').innerText = this.value">
                        <span class="brightness-display" id="brightness${index}">${pin.brightness || 255}</span>
                    </div>
                    <div class="form-row" id="ledCountRow${index}" style="display: ${pin.mode == 3 ? 'flex' : 'none'};">
                        <label>LED Count:</label>
                        <input type="number" name="ledCount${index}" value="${pin.ledCount || 10}" min="1" max="100" placeholder="For WS2812B strips">
                    </div>
                    <div class="type-examples" id="ledCountHelp${index}" style="display: ${pin.mode == 3 ? 'block' : 'none'};">Number of LEDs in strip (WS2812B only)</div>
                `;
                
                container.appendChild(pinDiv);
            });
        }
        
        function toggleLedCountField(pinIndex, modeValue) {
            const ledCountRow = document.getElementById(`ledCountRow${pinIndex}`);
            const ledCountHelp = document.getElementById(`ledCountHelp${pinIndex}`);
            const isWS2812B = (modeValue == 3); // WS2812B mode
            
            if (ledCountRow) {
                ledCountRow.style.display = isWS2812B ? 'flex' : 'none';
            }
            if (ledCountHelp) {
                ledCountHelp.style.display = isWS2812B ? 'block' : 'none';
            }
        }

        function updateTypeDescription(pinIndex, typeValue) {
            const customField = document.getElementById(`customType${pinIndex}`);
            const description = document.getElementById(`typeDescription${pinIndex}`);
            
            // Show/hide custom type input
            if (customField) {
                customField.style.display = (typeValue === 'Custom') ? 'inline-block' : 'none';
                if (typeValue !== 'Custom') {
                    customField.value = ''; // Clear custom field when not using it
                }
            }
            
            // Update description based on selected type
            if (description) {
                const descriptions = {
                    'Engine': 'Creates Engine Idle and Engine Rev effect buttons',
                    'MachineGun': 'Creates Machine Gun Burst effect button',  
                    'Flamethrower': 'Creates Flamethrower effect button',
                    'RocketLauncher': 'Creates Rocket Launch effect button',
                    'MainCannon': 'Creates Main Cannon Blast effect button',
                    'Candle': 'Creates Candle Flicker and Bright effect buttons',
                    'Console': 'Creates Console Data Scroll and Alert Pulse buttons',
                    'Damage': 'Creates Damage/Hit Sparks effect button',
                    'Ambient': 'Creates general lighting effect buttons',
                    'Custom': 'Enter custom type name for specialized effects',
                    '': 'Select a pin type to see available effects'
                };
                description.textContent = descriptions[typeValue] || 'Effect buttons based on configured pin types';
            }
        }

        function restartDevice() {
            if (confirm('Restart the device to apply WiFi configuration changes?\n\nThe device will be unavailable for about 10 seconds.')) {
                fetch('/restart', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        // Show success message and redirect
                        document.body.innerHTML = '<div style="font-family:Arial; background:#1a1a2e; color:white; text-align:center; padding:50px;"><h1>üîÑ Device Restarting...</h1><p>Please wait while the device restarts and reconnects to your network.</p></div>';
                    } else {
                        alert('Failed to restart device. Please try power cycling manually.');
                    }
                }).catch(error => {
                    alert('Error restarting device: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pin Configuration - BattleAura</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header class="hero-compact">
            <h1>üîå Pin Configuration</h1>
            <p class="hero-subtitle">Configure GPIO pins for your miniature</p>
            <nav><a href="/config">‚Üê Back to Config</a></nav>
        </header>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">üîå</div>
                <div>
                    <h2 class="card-title">Pin Assignments</h2>
                    <p class="card-description">Configure GPIO pins, types, and settings</p>
                </div>
            </div>
            
            <div id="pin-config-slots">
                <div class="loading">Loading pin configuration...</div>
            </div>
            
            <div class="form-actions">
                <button type="button" onclick="savePinConfiguration()" class="btn btn-primary">üíæ Save Configuration</button>
                <button type="button" onclick="loadPinConfiguration()" class="btn btn-secondary">üîÑ Reset Changes</button>
                <button type="button" onclick="testAllPins()" class="btn btn-warning">‚ö° Test All Pins</button>
            </div>
        </div>

        <section class="pin-info">
            <h2>Pin Configuration Guide</h2>
            
            <div class="pin-types">
                <h3>Pin Modes</h3>
                <ul>
                    <li><strong>PWM:</strong> Single-color LEDs with brightness control</li>
                    <li><strong>WS2812B:</strong> RGB addressable LED strips</li>
                    <li><strong>Digital:</strong> Simple on/off control</li>
                    <li><strong>Disabled:</strong> Pin not used</li>
                </ul>
            </div>
            
            <div class="effect-types">
                <h3>Common Effect Types</h3>
                <ul>
                    <li><strong>Engine:</strong> Vehicle engines, reactors</li>
                    <li><strong>Weapon:</strong> Guns, cannons, missiles</li>
                    <li><strong>Candle:</strong> Fires, torches, flames</li>
                    <li><strong>Console:</strong> Computer screens, dashboards</li>
                    <li><strong>Damage:</strong> Sparks, damage indicators</li>
                </ul>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadPinConfiguration();
        });
        
        async function loadPinConfiguration() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                generatePinConfigUI(config.pins || []);
            } catch (error) {
                console.error('Failed to load pin configuration:', error);
                document.getElementById('pin-config-slots').innerHTML = 
                    '<p class="text-secondary">Failed to load pin configuration</p>';
            }
        }
        
        function generatePinConfigUI(pins) {
            const container = document.getElementById('pin-config-slots');
            let html = '<div class="pin-config-grid">';
            
            for (let i = 0; i < 8; i++) { // MAX_PINS = 8 // Show 10 pin slots
                const pin = pins[i] || { gpio: i, enabled: false, name: '', type: '', group: '', mode: 0, brightness: 255, ledCount: 10 };
                
                html += `
                    <div class="pin-config-card" data-pin="${i}">
                        <div class="pin-config-header">
                            <h3>Pin ${i}</h3>
                            <label class="checkbox-container">
                                <input type="checkbox" id="enabled-${i}" ${pin.enabled ? 'checked' : ''} 
                                       onchange="togglePinConfig(${i}, this.checked)">
                                <span class="checkbox-label">Enabled</span>
                            </label>
                        </div>
                        
                        <div class="pin-config-fields" id="fields-${i}" style="display: ${pin.enabled ? 'block' : 'none'}">
                            <div class="form-row">
                                <label for="gpio-${i}">GPIO Pin:</label>
                                <input type="number" id="gpio-${i}" value="${pin.gpio}" min="0" max="21">
                            </div>
                            
                            <div class="form-row">
                                <label for="name-${i}">Pin Name:</label>
                                <input type="text" id="name-${i}" value="${pin.name}" placeholder="e.g. Candles, Engine1">
                            </div>
                            
                            <div class="form-row">
                                <label for="type-${i}">Pin Type:</label>
                                <select id="type-${i}" onchange="toggleCustomTypeField(${i}, this.value)">
                                    <option value="">-- Select Type --</option>
                                    <option value="Candle" ${pin.type === 'Candle' ? 'selected' : ''}>üïØÔ∏è Candle</option>
                                    <option value="Engine" ${pin.type === 'Engine' ? 'selected' : ''}>üîÑ Engine</option>
                                    <option value="Weapon" ${pin.type === 'Weapon' ? 'selected' : ''}>üî´ Weapon</option>
                                    <option value="Console" ${pin.type === 'Console' ? 'selected' : ''}>üìä Console</option>
                                    <option value="Damage" ${pin.type === 'Damage' ? 'selected' : ''}>‚ö° Damage</option>
                                    <option value="Ambient" ${pin.type === 'Ambient' ? 'selected' : ''}>üí° Ambient</option>
                                    <option value="Custom" ${!['', 'Candle', 'Engine', 'Weapon', 'Console', 'Damage', 'Ambient'].includes(pin.type) ? 'selected' : ''}>‚úèÔ∏è Custom</option>
                                </select>
                                <div class="form-row" id="custom-type-${i}" style="display: ${!['', 'Candle', 'Engine', 'Weapon', 'Console', 'Damage', 'Ambient'].includes(pin.type) ? 'block' : 'none'}; margin-top: var(--space-2);">
                                    <label for="custom-type-input-${i}">Custom Type:</label>
                                    <input type="text" id="custom-type-input-${i}" value="${!['', 'Candle', 'Engine', 'Weapon', 'Console', 'Damage', 'Ambient'].includes(pin.type) ? pin.type : ''}" placeholder="Enter custom type">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <label for="group-${i}">Group:</label>
                                <input type="text" id="group-${i}" value="${pin.group}" placeholder="e.g. Candles, Engine1, Weapons">
                            </div>
                            
                            <div class="form-row">
                                <label for="mode-${i}">Pin Mode:</label>
                                <select id="mode-${i}" onchange="toggleLedCountField(${i}, this.value)">
                                    <option value="0" ${pin.mode === 0 ? 'selected' : ''}>Disabled</option>
                                    <option value="1" ${pin.mode === 1 ? 'selected' : ''}>Digital (On/Off)</option>
                                    <option value="2" ${pin.mode === 2 ? 'selected' : ''}>PWM (Brightness)</option>
                                    <option value="3" ${pin.mode === 3 ? 'selected' : ''}>WS2812B (RGB Strip)</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <label for="brightness-${i}">Max Brightness:</label>
                                <div class="brightness-control">
                                    <input type="range" id="brightness-${i}" min="0" max="255" value="${pin.brightness}" 
                                           oninput="updateBrightnessDisplay(${i}, this.value)">
                                    <span id="brightness-display-${i}">${Math.round(pin.brightness/255*100)}%</span>
                                </div>
                            </div>
                            
                            <div class="form-row" id="ledCount-${i}" style="display: ${pin.mode === 3 ? 'block' : 'none'}">
                                <label for="ledcount-${i}">LED Count (WS2812B):</label>
                                <input type="number" id="ledcount-${i}" value="${pin.ledCount}" min="1" max="100">
                            </div>
                            
                            <div class="pin-test-button">
                                <button type="button" onclick="testPin(${i})" class="btn btn-sm btn-secondary">‚ö° Test Pin</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function togglePinConfig(pinIndex, enabled) {
            const fields = document.getElementById('fields-' + pinIndex);
            if (fields) {
                fields.style.display = enabled ? 'block' : 'none';
            }
        }
        
        function toggleLedCountField(pinIndex, mode) {
            const ledCountRow = document.getElementById('ledCount' + pinIndex);
            if (ledCountRow) {
                ledCountRow.style.display = (mode == '3') ? 'block' : 'none';
            }
        }
        
        function updateBrightnessDisplay(pinIndex, value) {
            const display = document.getElementById('brightness-display-' + pinIndex);
            if (display) {
                display.textContent = Math.round(value/255*100) + '%';
            }
        }
        
        async function savePinConfiguration() {
            const pins = [];
            
            for (let i = 0; i < 8; i++) { // MAX_PINS = 8
                const enabled = document.getElementById('enabled-' + i).checked;
                
                // Handle custom type field
                let pinType = document.getElementById('type-' + i).value;
                if (pinType === 'Custom') {
                    const customTypeInput = document.getElementById('custom-type-input-' + i);
                    pinType = customTypeInput ? customTypeInput.value : '';
                }
                
                pins.push({
                    gpio: parseInt(document.getElementById('gpio-' + i).value) || i,
                    enabled: enabled,
                    name: document.getElementById('name-' + i).value,
                    type: pinType,
                    group: document.getElementById('group-' + i).value,
                    mode: parseInt(document.getElementById('mode-' + i).value),
                    brightness: parseInt(document.getElementById('brightness-' + i).value),
                    ledCount: parseInt(document.getElementById('ledcount-' + i).value) || 10
                });
            }
            
            try {
                const response = await fetch('/config/pins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pins: pins })
                });
                
                if (response.ok) {
                    showFeedback('Pin configuration saved!', 'success');
                } else {
                    // Try to get specific error message from response
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            showFeedback('Configuration error: ' + errorData.error, 'error');
                        } else {
                            showFeedback('Failed to save configuration', 'error');
                        }
                    } catch {
                        showFeedback('Failed to save configuration (HTTP ' + response.status + ')', 'error');
                    }
                }
            } catch (error) {
                console.error('Save error:', error);
                showFeedback('Save failed', 'error');
            }
        }
        
        function testAllPins() {
            fetch('/api/test-pins', { method: 'POST' })
                .then(() => showFeedback('Testing all pins...', 'success'))
                .catch(e => showFeedback('Pin test failed', 'error'));
        }
        
        function testPin(pinIndex) {
            fetch('/api/test-pin/' + pinIndex, { method: 'POST' })
                .then(() => showFeedback('Testing pin ' + pinIndex, 'success'))
                .catch(e => showFeedback('Pin test failed', 'error'));
        }
        
        function showFeedback(message, type) {
            // Simple feedback display - could be improved
            alert(message);
        }
        
        function toggleCustomTypeField(pinIndex, selectedValue) {
            const customField = document.getElementById('custom-type-' + pinIndex);
            if (selectedValue === 'Custom') {
                customField.style.display = 'block';
            } else {
                customField.style.display = 'none';
            }
        }
        
        function toggleLedCountField(pinIndex, selectedMode) {
            // Mode 3 = WS2812B
            const ledCountField = document.getElementById('ledcount-row-' + pinIndex);
            if (ledCountField) {
                if (selectedMode == 3) {
                    ledCountField.style.display = 'block';
                } else {
                    ledCountField.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>